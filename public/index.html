<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>SMCS – Live Ship Tracker</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #000;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* LOGO */
    #logo {
      position: absolute;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      text-align: center;
      pointer-events: none;
    }

    #logo img {
      height: 70px;
      opacity: 0.9;
    }

    #logo span {
      display: block;
      margin-top: 4px;
      font-family: sans-serif;
      letter-spacing: 4px;
      font-size: 12px;
      color: rgba(255,255,255,0.6);
    }

    /* ICONE NAVI */
    .ship {
      font-size: 20px;
      transform-origin: center;
      text-shadow: 0 0 6px rgba(0,0,0,0.8);
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="logo">
  <img src="/logo.png" />
  <span>WORLDWIDE SAFETY</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =========================
   COLORI PER COMPAGNIA
========================= */

const COMPANY_COLORS = {
  "MSC": "#00c8ff",
  "AIDA": "#ffcc00",
  "COSTA": "#ff3300",
  "RCCL": "#6a5acd",
  "CARNIVAL": "#ff0066",
  "DISNEY": "#00ffff",
  "VIKING": "#cccccc"
};

function shipIcon(heading, companyCode) {
  const color = COMPANY_COLORS[companyCode] || "#999999";

  return L.divIcon({
    className: "",
    html: `
      <div class="ship" style="color:${color}; transform: rotate(${heading}deg)">
        ▲
      </div>
    `,
    iconSize: [24, 24],
    iconAnchor: [12, 12]
  });
}

/* =========================
   MAPPA (SENZA GRIGLIA)
========================= */

const map = L.map("map", {
  worldCopyJump: false,
  continuousWorld: false,
  maxBounds: [[-85, -180], [85, 180]],
  maxBoundsViscosity: 1.0
}).setView([20, 0], 2);

L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  { attribution: "" }
).addTo(map);

const shipLayer = L.layerGroup().addTo(map);

/* =========================
   UPDATE NAVI
========================= */

async function updateShips() {
  const res = await fetch("/ships", { cache: "no-store" });
  const ships = await res.json();

  shipLayer.clearLayers();

  ships.forEach(ship => {
    if (!ship.lat || !ship.lon) return;

    L.marker([ship.lat, ship.lon], {
      icon: shipIcon(ship.heading || 0, ship.company_code)
    })
    .addTo(shipLayer)
    .bindPopup(`
      <b>${ship.name || "Unknown"}</b><br>
      ${ship.company_name || ""}<br>
      MMSI: ${ship.mmsi}
    `);
  });
}

updateShips();
setInterval(updateShips, 30000);
</script>

</body>
</html>