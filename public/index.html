<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>SMCS â€“ Worldwide Safety</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #000;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* LOGO */
    #logo {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      text-align: center;
      pointer-events: none;
    }

    #logo img {
      height: 48px;
      opacity: 0.9;
    }

    #logo div {
      margin-top: 4px;
      font-family: Arial, sans-serif;
      letter-spacing: 2px;
      font-size: 12px;
      color: rgba(255,255,255,0.7);
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="logo">
  <img src="logo.png" alt="SMCS Logo" />
  <div>WORLDWIDE SAFETY</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =========================
   MAP INIT
========================= */

const map = L.map("map", {
  worldCopyJump: false,
  maxBounds: [[-90, -180], [90, 180]],
  maxBoundsViscosity: 1.0
}).setView([20, 0], 2);

/* ===== BASE LAYERS ===== */

const darkLayer = L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  { noWrap: true }
);

const lightLayer = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { noWrap: true }
);

darkLayer.addTo(map);

/* ===== DAY / NIGHT SWITCH ===== */

L.control.layers(
  {
    "Night": darkLayer,
    "Day": lightLayer
  },
  null,
  { position: "bottomright" }
).addTo(map);

// kiosk resize fix
setTimeout(() => map.invalidateSize(), 200);

/* =========================
   COMPANY COLORS
========================= */

const COMPANY_COLORS = {
  "CARNIVAL": "#e31937",
  "DISNEY": "#1b4cff",
  "COSTA": "#ffd200",
  "MSC": "#003a8f",
  "AIDA": "#ff6f00",
  "PRINCESS": "#5b7db1",
  "HAL": "#0b3d2e",
  "PO": "#002b5c",
  "POAUS": "#005aa7",
  "CUNARD": "#8b0000",
  "VIKING": "#9e9e9e",
  "NCL": "#1c8adb",
  "VIRGIN": "#c8102e",
  "SILVERSEA": "#b9b9b9",
  "SEABOURN": "#7a7a7a",
  "PONANT": "#1f4e79",
  "TUI": "#d0002d",
  "ROYAL": "#00205b",
  "AZAMARA": "#6a1b9a",
  "RITZ": "#c9a23f",
  "PEACEBOAT": "#2e7d32",
  "HAPAG": "#0a1a3a",
  "ADORA": "#e60012",
  "CMV": "#1565c0"
};

const DEFAULT_COLOR = "#9e9e9e";

/* =========================
   ICON
========================= */

function shipIcon(heading = 0, companyCode = "") {
  const color = COMPANY_COLORS[companyCode] || DEFAULT_COLOR;

  return L.divIcon({
    className: "",
    html: `
      <div style="
        width: 0;
        height: 0;
        border-left: 7px solid transparent;
        border-right: 7px solid transparent;
        border-bottom: 14px solid ${color};
        transform: rotate(${heading}deg);
        transform-origin: center;
      "></div>
    `,
    iconSize: [14, 14],
    iconAnchor: [7, 7]
  });
}

/* =========================
   SHIP LAYER
========================= */

const shipLayer = L.layerGroup().addTo(map);

/* =========================
   UPDATE SHIPS
========================= */

async function updateShips() {
  try {
    const res = await fetch("/ships", { cache: "no-store" });
    const ships = await res.json();

    shipLayer.clearLayers();

    ships.forEach(ship => {
      if (ship.lat == null || ship.lon == null) return;

      const lat = Number(ship.lat);
      const lon = Number(ship.lon);
      if (Number.isNaN(lat) || Number.isNaN(lon)) return;

      L.marker([lat, lon], {
        icon: shipIcon(ship.heading, ship.company_code)
      })
      .addTo(shipLayer)
      .bindTooltip(
        `<b>${ship.name}</b><br>${ship.company_name}`,
        { direction: "top", offset: [0, -8], opacity: 0.9 }
      );
    });

  } catch (err) {
    console.error("Ship update error:", err);
  }
}

/* =========================
   START
========================= */

updateShips();
setInterval(updateShips, 30000);
</script>

</body>
</html>
