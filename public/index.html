<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>SMCS – Live Ship Tracker</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #000;
    }

    #map {
      width: 100%;
      height: 100%;
      background: #000;
    }

    /* Rimuove qualsiasi seam */
    .leaflet-tile {
      border: none !important;
      outline: none !important;
    }

    /* Brand label */
    #centerLabel {
      position: absolute;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      font-family: Arial, Helvetica, sans-serif;
      font-size: 26px;
      letter-spacing: 6px;
      font-weight: 300;
      color: rgba(255, 255, 255, 0.18);
      pointer-events: none;
      user-select: none;
      z-index: 500;
      white-space: nowrap;
    }

    #status {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 8px 14px;
      border-radius: 6px;
      font-family: sans-serif;
      font-size: 14px;
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div id="centerLabel">SMCS WORLDWIDE SAFETY</div>
<div id="status">Waiting for live AIS data…</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =========================
   MAP INIT
========================= */

const map = L.map("map", {
  worldCopyJump: false,
  zoomControl: true,
  inertia: true
}).setView([20, 0], 2);

/* Blocco longitudine SENZA setMaxBounds */
map.on("drag", () => {
  const c = map.getCenter();
  if (c.lng < -180) c.lng = -180;
  if (c.lng > 180) c.lng = 180;
  map.panTo(c, { animate: false });
});

/* =========================
   TILE CLEAN (NO GRID)
========================= */

L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png",
  {
    attribution: "© OpenStreetMap © Carto",
    noWrap: true,
    detectRetina: true
  }
).addTo(map);

setTimeout(() => map.invalidateSize(), 200);

/* =========================
   SHIP LAYER
========================= */

const shipLayer = L.layerGroup().addTo(map);

/* =========================
   COMPANY COLORS
========================= */

const companyColors = {
  "MSC": "#007aff",
  "Costa": "#34c759",
  "Carnival": "#ff3b30",
  "Royal Caribbean": "#ff9500",
  "Disney": "#af52de"
};

const defaultColor = "#b0b0b0";

/* =========================
   SHIP ICON
========================= */

function shipIcon(heading = 0, company = null, simulated = false) {
  const color = simulated
    ? "#ff453a"
    : companyColors[company] || defaultColor;

  return L.divIcon({
    className: "",
    html: `
      <svg width="26" height="26" viewBox="0 0 24 24"
           style="transform: rotate(${heading}deg)">
        <polygon
          points="12,2 21,22 12,18 3,22"
          fill="${color}"
        />
      </svg>
    `,
    iconSize: [26, 26],
    iconAnchor: [13, 13]
  });
}

/* =========================
   UPDATE SHIPS
========================= */

async function updateShips() {
  try {
    const res = await fetch("/ships", { cache: "no-store" });
    const ships = await res.json();
    const status = document.getElementById("status");

    shipLayer.clearLayers();

    if (!ships || ships.length === 0) {
      status.style.display = "block";
      return;
    } else {
      status.style.display = "none";
    }

    ships.forEach(ship => {
      if (ship.lat == null || ship.lon == null) return;

      L.marker([ship.lat, ship.lon], {
        icon: shipIcon(ship.heading, ship.company, ship.simulated)
      })
      .addTo(shipLayer)
      .bindTooltip(
        `<b>${ship.name}</b><br>${ship.company || ""}`,
        { direction: "top", offset: [0, -10] }
      );
    });

  } catch (err) {
    console.error("Error fetching ships:", err);
  }
}

updateShips();
setInterval(updateShips, 30000);
</script>

</body>
</html>