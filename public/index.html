<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0" />
  <title>SMCS ‚Äì Worldwide Safety</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Leaflet Fullscreen -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.css" />

  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      overflow: hidden;
    }

    #map {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
    }

    #logo {
      position: fixed;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 700;
      pointer-events: none;
      opacity: 0.28;
      text-align: center;
    }

    #logo img { height: 56px; }

    #logo div {
      margin-top: 4px;
      font-family: Arial, sans-serif;
      letter-spacing: 2.5px;
      font-size: 12px;
      color: #cfd6dc;
    }

    #themeToggle {
      position: fixed;
      top: 14px;
      right: 16px;
      z-index: 700;
      font-size: 20px;
      cursor: pointer;
      opacity: 0.85;
    }

    #shipCounter {
      position: fixed;
      bottom: 14px;
      left: 16px;
      z-index: 700;
      font-family: Arial, sans-serif;
      font-size: 12px;
      color: #cfd6dc;
      opacity: 0.55;
      pointer-events: none;
    }

    .leaflet-control-zoom,
    .leaflet-control-fullscreen,
    .leaflet-control-reset {
      box-shadow: none !important;
      border: none !important;
    }

    .leaflet-control-zoom a,
    .leaflet-control-fullscreen a,
    .leaflet-control-reset a {
      background-color: rgba(28,29,34,0.55);
      color: #e5e5e5;
      width: 28px;
      height: 28px;
      line-height: 28px;
      font-size: 14px;
      text-align: center;
      cursor: pointer;
      opacity: 0.4;
      text-decoration: none;
    }

    .leaflet-control-zoom a:hover,
    .leaflet-control-fullscreen a:hover,
    .leaflet-control-reset a:hover {
      opacity: 0.9;
    }

    .leaflet-control-attribution {
      opacity: 0;
      pointer-events: none;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div id="logo">
  <img src="logo-martec-marine.png">
  <div>WORLDWIDE SAFETY</div>
</div>

<div id="themeToggle">üåô</div>
<div id="shipCounter"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.fullscreen@1.6.0/Control.FullScreen.js"></script>

<script>
  /* =========================
     MAP INIT
  ========================= */

  const map = L.map("map", {
    zoomControl: true,
    worldCopyJump: true,
    scrollWheelZoom: true,
    wheelDebounceTime: 120,
    wheelPxPerZoomLevel: 140,
    zoomSnap: 0.5,
    zoomDelta: 0.5
  });

  let initialCenter = [20, 0];
  let initialZoom;

  const darkLayer = L.tileLayer(
    "https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png",
    { noWrap: false }
  ).addTo(map);

  const lightLayer = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { noWrap: false }
  );

  map.setView(initialCenter, 2);

  setTimeout(() => {
    const bounds = L.latLngBounds(
      L.latLng(-60, -180),
      L.latLng(85, 180)
    );
    initialZoom = map.getBoundsZoom(bounds, true);
    map.setView(initialCenter, initialZoom);
    map.setMinZoom(initialZoom);
  }, 0);

  /* FULLSCREEN */
  map.addControl(
    L.control.fullscreen({
      position: "topleft",
      fullscreenElement: document.body
    })
  );

  /* RESET VIEW CONTROL */
  const ResetControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function () {
      const container = L.DomUtil.create('div', 'leaflet-control leaflet-control-reset');
      const btn = L.DomUtil.create('a', '', container);
      btn.innerHTML = '‚åÇ';
      btn.title = 'Reset view';

      L.DomEvent.on(btn, 'click', L.DomEvent.stop)
                .on(btn, 'click', () => {
                  map.setView(initialCenter, initialZoom);
                });

      return container;
    }
  });
  map.addControl(new ResetControl());

  /* THEME */
  let isDark = true;
  document.getElementById("themeToggle").onclick = () => {
    if (isDark) {
      map.removeLayer(darkLayer);
      lightLayer.addTo(map);
      themeToggle.textContent = "‚òÄÔ∏è";
    } else {
      map.removeLayer(lightLayer);
      darkLayer.addTo(map);
      themeToggle.textContent = "üåô";
    }
    isDark = !isDark;
  };

  /* SHIPS */
  const shipLayer = L.layerGroup().addTo(map);

  function companyFromName(name = "") {
    const n = name.toUpperCase();
    if (n.includes("MSC")) return "#0a84ff";
    if (n.includes("COSTA")) return "#ffd200";
    if (n.includes("DISNEY")) return "#bf5af2";
    return "#9fa3a7";
  }

  function shipIcon(heading, name, state) {
    const opacity = state === "LIVE" ? 1 : state === "RECENT" ? 0.4 : 0.15;
    return L.divIcon({
      html: `
        <svg width="26" height="26" viewBox="0 0 24 24"
             style="transform: rotate(${heading}deg); opacity:${opacity}">
          <polygon points="12,2 21,22 12,18 3,22"
                   fill="${companyFromName(name)}" />
        </svg>`,
      iconSize: [26,26],
      iconAnchor: [13,13]
    });
  }

  async function updateShips() {
    const res = await fetch("/ships", { cache: "no-store" });
    const ships = await res.json();

    shipLayer.clearLayers();

    let live = 0, recent = 0;

    ships.forEach(s => {
      if (s.state === "LIVE") live++;
      if (s.state === "RECENT") recent++;
      if (s.lat == null || s.lon == null) return;

      L.marker([s.lat, s.lon], {
        icon: shipIcon(s.heading, s.name, s.state)
      }).addTo(shipLayer);
    });

    shipCounter.textContent = `${live} live ¬∑ ${recent} recent ¬∑ ${ships.length} total`;
  }

  updateShips();
  setInterval(updateShips, 30000);
</script>

</body>
</html>