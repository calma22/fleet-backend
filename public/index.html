<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>SMCS ‚Äì Live Ship Tracker</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #000;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* BRAND TEXT */
    #centerLabel {
      position: absolute;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      font-family: Arial, Helvetica, sans-serif;
      font-size: 26px;
      letter-spacing: 6px;
      font-weight: 300;
      color: rgba(255, 255, 255, 0.18);
      pointer-events: none;
      user-select: none;
      z-index: 500;
      white-space: nowrap;
    }

    /* STATUS */
    #status {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 8px 14px;
      border-radius: 6px;
      font-family: sans-serif;
      font-size: 14px;
      z-index: 1000;
      display: none;
    }

    /* THEME TOGGLE */
    #themeToggle {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 1000;
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      user-select: none;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div id="centerLabel">SMCS WORLDWIDE SAFETY</div>
<div id="status">Waiting for live AIS data‚Ä¶</div>
<div id="themeToggle">üåô</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =========================
   MAP INIT
========================= */

const map = L.map("map", {
  worldCopyJump: false
}).setView([20, 0], 2);

/* =========================
   BLOCK WORLD WRAP
========================= */

const bounds = L.latLngBounds(
  L.latLng(-85, -180),
  L.latLng(85, 180)
);
map.setMaxBounds(bounds);
map.options.maxBoundsViscosity = 1.0;

/* =========================
   TILE LAYERS
========================= */

const lightLayer = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {
    attribution: "¬© OpenStreetMap",
    noWrap: true
  }
);

/* üî• DARK ‚Äì NO GRID, NO LABELS */
const darkLayer = L.tileLayer(
  "https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png",
  {
    attribution: "¬© OpenMapTiles ¬© OpenStreetMap contributors",
    noWrap: true
  }
);

let currentTheme = "dark";
darkLayer.addTo(map);

// Leaflet resize fix
setTimeout(() => map.invalidateSize(), 200);

/* =========================
   THEME TOGGLE
========================= */

const themeToggle = document.getElementById("themeToggle");
themeToggle.onclick = () => {
  if (currentTheme === "dark") {
    map.removeLayer(darkLayer);
    lightLayer.addTo(map);
    currentTheme = "light";
    themeToggle.textContent = "‚òÄÔ∏è";
  } else {
    map.removeLayer(lightLayer);
    darkLayer.addTo(map);
    currentTheme = "dark";
    themeToggle.textContent = "üåô";
  }
};

/* =========================
   COMPANY COLORS + ALIASES
========================= */

const companyColors = {
  "Carnival": "#ff3b30",
  "MSC": "#007aff",
  "Costa": "#34c759",
  "Royal Caribbean": "#ff9500",
  "Disney": "#af52de"
};

const companyAliases = {
  "Carnival": [
    "Carnival Cruise Lines",
    "Carnival Cruise Line",
    "Carnival Corporation"
  ],
  "MSC": [
    "MSC Crociere",
    "MSC Cruises"
  ],
  "Costa": [
    "Costa Crociere",
    "Costa Cruises"
  ],
  "Royal Caribbean": [
    "Royal Caribbean",
    "Royal Caribbean Cruises Ltd"
  ],
  "Disney": [
    "Disney Cruise Line"
  ]
};

const defaultColor = "#9e9e9e";

function normalizeCompany(company) {
  if (!company) return null;
  for (const key in companyAliases) {
    if (companyAliases[key].includes(company)) {
      return key;
    }
  }
  return null;
}

/* =========================
   SHIP LAYER
========================= */

const shipLayer = L.layerGroup().addTo(map);

/* =========================
   SHIP ICON (SVG)
========================= */

function shipIcon(heading = 0, company = null, simulated = false) {
  const normalized = normalizeCompany(company);
  const color = simulated
    ? "red"
    : normalized
      ? companyColors[normalized]
      : defaultColor;

  return L.divIcon({
    className: "",
    html: `
      <svg width="24" height="24" viewBox="0 0 24 24"
           style="transform: rotate(${heading}deg);">
        <polygon
          points="12,2 20,22 12,18 4,22"
          fill="${color}"
        />
      </svg>
    `,
    iconSize: [24, 24],
    iconAnchor: [12, 12]
  });
}

/* =========================
   UPDATE SHIPS
========================= */

async function updateShips() {
  try {
    const res = await fetch("/ships", { cache: "no-store" });
    const ships = await res.json();
    const status = document.getElementById("status");

    shipLayer.clearLayers();

    if (!ships || ships.length === 0) {
      status.style.display = "block";
      return;
    } else {
      status.style.display = "none";
    }

    ships.forEach(ship => {
      if (ship.lat == null || ship.lon == null) return;

      const lat = Number(ship.lat);
      const lon = Number(ship.lon);
      if (Number.isNaN(lat) || Number.isNaN(lon)) return;

      L.marker([lat, lon], {
        icon: shipIcon(
          ship.heading,
          ship.company || null,
          ship.simulated
        )
      })
      .addTo(shipLayer)
      .bindTooltip(
        `<b>${ship.name}</b><br/>${ship.company || ""}`,
        { direction: "top", offset: [0, -10] }
      );
    });

  } catch (err) {
    console.error("Error fetching ships:", err);
  }
}

updateShips();
setInterval(updateShips, 30000);
</script>

</body>
</html>