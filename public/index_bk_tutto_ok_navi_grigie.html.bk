<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>SMCS – Live Ship Tracker</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #000;
    }

    #map {
      width: 100%;
      height: 100%;
      background: #000;
    }

    /* rimuove qualsiasi linea / seam */
    .leaflet-tile {
      border: none !important;
      outline: none !important;
    }

    /* =========================
       LOGO + TAGLINE
    ========================= */

    #brand {
      position: absolute;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 600;
      pointer-events: none;
      text-align: center;
      opacity: 0.28;
    }

    #brand img {
      height: 64px;
      width: auto;
      display: block;
      margin: 0 auto;
    }

    #brand .tagline {
      margin-top: 4px;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 12px;
      letter-spacing: 2.5px;
      color: #cfd6dc;
    }

    /* =========================
       STATUS
    ========================= */

    #status {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 8px 14px;
      border-radius: 6px;
      font-family: sans-serif;
      font-size: 14px;
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- BRAND -->
<div id="brand">
  <img src="logo-martec-marine.png" alt="Martec Marine">
  <div class="tagline">WORLDWIDE SAFETY</div>
</div>

<div id="status">Waiting for live AIS data…</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =========================
   MAP INIT
========================= */

const map = L.map("map", {
  worldCopyJump: false,
  zoomControl: true,
  inertia: true
}).setView([20, 0], 2);

/* blocco longitudine */
map.on("drag", () => {
  const c = map.getCenter();
  if (c.lng < -180) c.lng = -180;
  if (c.lng > 180) c.lng = 180;
  map.panTo(c, { animate: false });
});

/* =========================
   TILE (DARK – NO GRID)
========================= */

L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png",
  {
    attribution: "© OpenStreetMap © Carto",
    noWrap: true,
    detectRetina: true
  }
).addTo(map);

setTimeout(() => map.invalidateSize(), 200);

/* =========================
   SHIP LAYER
========================= */

const shipLayer = L.layerGroup().addTo(map);

/* =========================
   COMPANY COLORS
========================= */

const companyColors = {
  "MSC": "#0a84ff",
  "Costa": "#30d158",
  "Carnival": "#ff453a",
  "Royal Caribbean": "#ff9f0a",
  "Disney": "#bf5af2"
};

const defaultColor = "#9fa3a7";

/* =========================
   SHIP ICON (SVG)
========================= */

function shipIcon(heading = 0, company = null, simulated = false) {
  const color = simulated
    ? "#ff453a"
    : companyColors[company] || defaultColor;

  return L.divIcon({
    className: "",
    html: `
      <svg width="26" height="26" viewBox="0 0 24 24"
           style="transform: rotate(${heading}deg)">
        <polygon
          points="12,2 21,22 12,18 3,22"
          fill="${color}"
        />
      </svg>
    `,
    iconSize: [26, 26],
    iconAnchor: [13, 13]
  });
}

/* =========================
   UPDATE SHIPS
========================= */

async function updateShips() {
  try {
    const res = await fetch("/ships", { cache: "no-store" });
    const ships = await res.json();
    const status = document.getElementById("status");

    shipLayer.clearLayers();

    if (!ships || ships.length === 0) {
      status.style.display = "block";
      return;
    } else {
      status.style.display = "none";
    }

    ships.forEach(ship => {
      if (ship.lat == null || ship.lon == null) return;

      L.marker([ship.lat, ship.lon], {
        icon: shipIcon(ship.heading, ship.company, ship.simulated)
      })
      .addTo(shipLayer)
      .bindTooltip(
        `<b>${ship.name}</b><br>${ship.company || ""}`,
        { direction: "top", offset: [0, -10] }
      );
    });

  } catch (err) {
    console.error("Error fetching ships:", err);
  }
}

updateShips();
setInterval(updateShips, 30000);
</script>

</body>
</html>
